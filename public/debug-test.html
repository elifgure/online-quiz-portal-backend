<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Debug Test</title>
    <!-- Socket.IO Client - CDN fallback ile -->
    <script src="/socket.io/socket.io.js" 
            onerror="this.onerror=null; this.src='https://cdn.socket.io/4.7.2/socket.io.min.js'"></script>
</head>
<body>
    <h1>Socket.IO Debug Test</h1>
    
    <div>
        <label>JWT Token:</label><br>
        <textarea id="tokenInput" style="width: 500px; height: 100px;" placeholder="JWT token'Ä±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n"></textarea><br>
        <button onclick="testConnection()">Test BaÄŸlantÄ±</button>
        <button onclick="testTokenAPI()">Test Token (API)</button>
    </div>
    
    <div id="output" style="margin-top: 20px; padding: 10px; background: #f5f5f5; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        async function testTokenAPI() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                alert('Token girin!');
                return;
            }

            log('ğŸ§ª API ile token test ediliyor...');
            
            try {
                const response = await fetch('/api/test/socket-status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                log(`ğŸ“¡ API Response: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success) {
                    log('âœ… Token geÃ§erli! Socket.IO baÄŸlantÄ±sÄ± denenebilir.');
                } else {
                    log('âŒ Token geÃ§ersiz!');
                }
            } catch (error) {
                log(`âŒ API HatasÄ±: ${error.message}`);
            }
        }

        function testConnection() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                alert('Token girin!');
                return;
            }

            log('ğŸ”Œ Socket.IO baÄŸlantÄ±sÄ± test ediliyor...');
            log(`ğŸ”‘ Token (ilk 50 karakter): ${token.substring(0, 50)}...`);

            const socket = io('http://localhost:5000', {
                auth: {
                    token: token
                },
                transports: ['polling', 'websocket'],
                forceNew: true,
                timeout: 15000
            });

            socket.on('connect', () => {
                log('âœ… BAÅARILI! Socket.IO baÄŸlantÄ±sÄ± kuruldu');
                log(`ğŸ†” Socket ID: ${socket.id}`);
                log(`ğŸš€ Transport: ${socket.io.engine.transport.name}`);
                
                // Test bildirimi gÃ¶nder
                socket.emit('test_message', { message: 'Merhaba Socket.IO!' });
            });

            socket.on('connect_error', (error) => {
                log(`âŒ BAÄLANTI HATASI: ${error.message}`);
                log(`âŒ Error Type: ${error.type || 'Unknown'}`);
                log(`âŒ Error Description: ${error.description || 'No description'}`);
            });

            socket.on('disconnect', (reason) => {
                log(`âš ï¸ BaÄŸlantÄ± kesildi: ${reason}`);
            });

            socket.on('notification', (data) => {
                log(`ğŸ“¨ Bildirim alÄ±ndÄ±: ${JSON.stringify(data)}`);
            });

            // 10 saniye sonra baÄŸlantÄ±yÄ± kapat
            setTimeout(() => {
                socket.disconnect();
                log('ğŸ”Œ Test baÄŸlantÄ±sÄ± kapatÄ±ldÄ±');
            }, 10000);
        }
    </script>
</body>
</html>
